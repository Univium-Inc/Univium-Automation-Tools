<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .config-table {
        width: 100%;
        border-collapse: collapse;
      }
      .config-table th, .config-table td {
        border: 1px solid #ccc;
        padding: 6px 8px;
      }
      .config-table th {
        background: #f2f2f2;
      }
      .buttons {
        margin-top: 12px;
      }
      .btn {
        background-color: #1976d2;
        color: white;
        border: none;
        padding: 6px 12px;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 8px;
      }
      .btn:hover {
        background-color: #1669bb;
      }
      .error {
        color: red;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>Configure Spreadsheets</h2>
    <p>Select which spreadsheets to compare (Compare=Y) and exactly one main (Main=Y).  
       If a spreadsheet is Main=Y, it must also be Compare=Y.</p>
    <div id="errorMsg" class="error"></div>

    <table class="config-table" id="configTable">
      <thead>
        <tr>
          <th>Spreadsheet ID</th>
          <th>Compare (Y/N)</th>
          <th>Main (Y/N)</th>
        </tr>
      </thead>
      <tbody>
        <!-- We'll populate rows dynamically via loadMasterData() -->
      </tbody>
    </table>

    <div class="buttons">
      <button class="btn" onclick="saveConfig()">Save</button>
      <button class="btn" onclick="closeDialog()">Close</button>
    </div>

    <script>
      let masterData = [];

      /**
       * Called onload: loads the Master config from server
       * and populates the table.
       */
      function loadMasterData() {
        google.script.run
          .withSuccessHandler(function(data) {
            masterData = data || [];
            buildTable();
          })
          .withFailureHandler(function(err) {
            document.getElementById('errorMsg').textContent = 'Error: ' + err.message;
          })
          .getMasterConfig();
      }

      /**
       * buildTable()
       * Renders each row from masterData into the HTML table.
       */
      function buildTable() {
        const tbody = document.getElementById('configTable').querySelector('tbody');
        tbody.innerHTML = ''; // clear existing

        masterData.forEach((row, index) => {
          const tr = document.createElement('tr');

          // A) Spreadsheet ID
          const tdId = document.createElement('td');
          tdId.textContent = row.spreadsheetId;
          tr.appendChild(tdId);

          // B) Compare -> Y/N -> use a checkbox
          const tdCompare = document.createElement('td');
          const compareCheckbox = document.createElement('input');
          compareCheckbox.type = 'checkbox';
          compareCheckbox.checked = (row.compare === 'Y');
          compareCheckbox.addEventListener('change', () => {
            row.compare = compareCheckbox.checked ? 'Y' : 'N';
          });
          tdCompare.appendChild(compareCheckbox);
          tr.appendChild(tdCompare);

          // C) Main -> Y/N -> use a radio group
          const tdMain = document.createElement('td');
          const mainRadio = document.createElement('input');
          mainRadio.type = 'radio';
          mainRadio.name = 'mainRadio'; // so only one can be selected
          mainRadio.checked = (row.main === 'Y');
          mainRadio.addEventListener('change', () => {
            // If user picks this as Main=Y, we uncheck all others in data
            masterData.forEach(r => (r.main = 'N'));
            row.main = 'Y';
            buildTable(); // re-render to update radio
          });
          tdMain.appendChild(mainRadio);
          tr.appendChild(tdMain);

          tbody.appendChild(tr);
        });
      }

      /**
       * saveConfig()
       * 1) Validate exactly one main=Y
       * 2) If main=Y, compare must be Y
       * 3) Save to the Master sheet via server
       */
      function saveConfig() {
        const errorDiv = document.getElementById('errorMsg');
        errorDiv.textContent = '';

        // Exactly one main
        const mainCount = masterData.filter(row => row.main === 'Y').length;
        if (mainCount !== 1) {
          errorDiv.textContent = 'You must select exactly ONE main spreadsheet.';
          return;
        }

        // If main=Y, then compare must=Y
        for (let row of masterData) {
          if (row.main === 'Y' && row.compare !== 'Y') {
            errorDiv.textContent = 
              `Spreadsheet ID: ${row.spreadsheetId} is main but not marked Compare=Y.`;
            return;
          }
        }

        // Save
        google.script.run
          .withSuccessHandler(function() {
            errorDiv.textContent = 'Saved successfully!';
          })
          .withFailureHandler(function(err) {
            errorDiv.textContent = 'Error: ' + err.message;
          })
          .saveMasterConfig(masterData);
      }

      /**
       * closeDialog()
       * Close the popup
       */
      function closeDialog() {
        google.script.host.close();
      }

      // Load data on startup
      window.onload = loadMasterData;
    </script>
  </body>
</html>
